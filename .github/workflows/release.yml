name: Create Release

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on version tags like v1.0.0

jobs:
  build-release:
    name: Build Release Artifacts
    runs-on: ubuntu-latest

    permissions:
      contents: write  # Needed to create releases

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Extract version from tag
      id: version
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Building version: $VERSION"

    - name: Cache Connect IQ SDK
      id: cache-sdk
      uses: actions/cache@v4
      with:
        path: ~/connectiq-sdk
        key: ${{ runner.os }}-connectiq-sdk-8.4.1

    - name: Download and install Connect IQ SDK
      if: steps.cache-sdk.outputs.cache-hit != 'true'
      run: |
        echo "Downloading Connect IQ SDK..."
        mkdir -p ~/connectiq-sdk
        cd ~/connectiq-sdk
        wget -q https://developer.garmin.com/downloads/connect-iq/sdks/connectiq-sdk-lin-8.4.1-2026-02-03-e9f77eeaa.zip -O sdk.zip
        unzip -q sdk.zip
        rm sdk.zip
        chmod +x bin/monkeyc bin/monkeydo

    - name: Decode developer key
      run: |
        echo "${{ secrets.DEVELOPER_KEY_DER }}" | base64 -d > developer_key.der

    - name: Create bin directory
      run: mkdir -p bin release

    - name: Build universal package
      run: |
        echo "Building universal .iq package for all supported devices..."
        echo "Note: Individual .prg builds require device files from SDK Manager"
        echo "The universal .iq package works for all devices in manifest.xml"
        mkdir -p bin

    - name: Build universal .iq package for store
      run: |
        echo "Building universal .iq package..."
        ~/connectiq-sdk/bin/monkeyc \
          -o "release/CPRTrainer-v${{ steps.version.outputs.version }}.iq" \
          -f monkey.jungle \
          -y developer_key.der \
          -r \
          -w
        echo "âœ… Universal .iq package created"

    - name: Copy .iq to release folder
      run: |
        cp bin/CPRTrainer-v${{ steps.version.outputs.version }}.iq release/
        echo "âœ… Release package ready"

    - name: Generate build info
      run: |
        cat > release/BUILD_INFO.txt << EOF
        CPR Trainer - Build Information
        ================================

        Version: ${{ steps.version.outputs.version }}
        Build Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        Git Commit: ${{ github.sha }}
        Git Tag: ${{ github.ref_name }}

        Files included:
        ---------------
        $(ls -lh release/)

        Installation:
        -------------
        1. Download CPRTrainer-v${{ steps.version.outputs.version }}.iq
        2. Install via Garmin Express (recommended) or Connect IQ mobile app
        3. Or sideload: Copy .iq file to watch and open with file manager

        For publishing to Connect IQ Store:
        -----------------------------------
        Upload the .iq file: CPRTrainer-v${{ steps.version.outputs.version }}.iq

        Supported Devices:
        ------------------
        See manifest.xml for the complete list of supported devices.
        The universal .iq package works on all devices listed in the manifest.

        Documentation:
        --------------
        - README.md: Main documentation
        - INSTALLATION.md: Installation guide
        - PUBLISHING.md: Publishing guide
        - DISCLAIMER.md: Important legal information

        Support:
        --------
        GitHub: https://github.com/[your-username]/garmin-cpr
        Issues: https://github.com/[your-username]/garmin-cpr/issues
        EOF

    - name: Generate checksums
      run: |
        cd release
        sha256sum * > SHA256SUMS.txt
        cat SHA256SUMS.txt
        cd ..

    - name: Create release notes
      id: release_notes
      run: |
        cat > release_notes.md << 'EOF'
        ## ðŸ«€ CPR Trainer v${{ steps.version.outputs.version }}

        ### âš ï¸ WICHTIGER HINWEIS
        Diese App ist ein Hilfsmittel zur UnterstÃ¼tzung geschulter Ersthelfer und ersetzt keine medizinische Ausbildung. Im Notfall immer zuerst **112** (Europa) oder **911** (USA) anrufen!

        ### ðŸ“¦ Downloads

        **Universal Package (works for all devices):**
        - `CPRTrainer-vX.X.X.iq` - Install via Garmin Express or Connect IQ Store

        **Installation:**
        1. Download the .iq file
        2. Install via Garmin Express (recommended) or Connect IQ mobile app
        3. Or copy to your device and install from there

        ### âœ¨ Features
        - ðŸŽµ 110 BPM Rhythmus (ERC Guidelines 2025)
        - ðŸ“Š 30:2 Protokoll
        - ðŸ“ Drucktiefe-Messung via Beschleunigungssensor
        - ðŸ“ˆ Echtzeit-Feedback ("Tiefer!", "Gut!", "Flacher!")
        - ðŸ“Š Statistiken (gute vs. zu flache/tiefe Kompressionen)
        - ðŸ”Š Vibrationen + TÃ¶ne
        - ðŸ’™ Beatmungs-Erinnerung

        ### ðŸ“± UnterstÃ¼tzte GerÃ¤te
        - Fenix Serie (7, 7S, 7X)
        - Venu Serie (2, 2 Plus)
        - Forerunner Serie (955)

        ### ðŸ“– Dokumentation
        - [Installation Guide](https://github.com/[your-username]/garmin-cpr/blob/main/INSTALLATION.md)
        - [Haftungsausschluss](https://github.com/[your-username]/garmin-cpr/blob/main/DISCLAIMER.md)
        - [Drucktiefe-Sensor Details](https://github.com/[your-username]/garmin-cpr/blob/main/DEPTH_SENSOR.md)

        ### ðŸ”’ Checksums
        SHA256 Checksums are included in `SHA256SUMS.txt`

        ### ðŸ™ Credits
        Based on ERC Guidelines 2025 | Inspired by corpuls primeCPR
        EOF

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          release/*
        body_path: release_notes.md
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Release summary
      run: |
        echo "### Release v${{ steps.version.outputs.version }} Created! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Artifacts:**" >> $GITHUB_STEP_SUMMARY
        ls -lh release/ | tail -n +2 | awk '{print "- " $9 " (" $5 ")"}' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Download:** [Release Page](https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }})" >> $GITHUB_STEP_SUMMARY
