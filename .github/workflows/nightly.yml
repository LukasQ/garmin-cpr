name: Nightly Build

on:
  schedule:
    # Run every day at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:  # Allow manual trigger

jobs:
  nightly-build:
    name: Nightly Compatibility Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout latest main
      uses: actions/checkout@v4
      with:
        ref: main

    - name: Cache SDK
      uses: actions/cache@v4
      with:
        path: ~/connectiq-sdk
        key: ${{ runner.os }}-connectiq-sdk-8.4.1

    - name: Install SDK
      run: |
        mkdir -p ~/connectiq-sdk
        cd ~/connectiq-sdk
        wget -q https://developer.garmin.com/downloads/connect-iq/sdks/connectiq-sdk-lin-8.4.1-2026-02-03-e9f77eeaa.zip -O sdk.zip
        unzip -q sdk.zip
        rm sdk.zip
        chmod +x bin/monkeyc

    - name: Decode developer key
      run: |
        echo "${{ secrets.DEVELOPER_KEY_DER }}" | base64 -d > developer_key.der

    - name: Build universal package
      continue-on-error: true
      run: |
        mkdir -p bin logs

        echo "Building universal .iq package for all devices in manifest..."
        if ~/connectiq-sdk/bin/monkeyc \
          -o "bin/CPRTrainer.iq" \
          -f monkey.jungle \
          -y developer_key.der \
          -r \
          -w > "logs/build.log" 2>&1; then
          echo "‚úÖ Build SUCCESS"
          echo "SUCCESS_COUNT=1" >> $GITHUB_ENV
          echo "FAILED_COUNT=0" >> $GITHUB_ENV
        else
          echo "‚ùå Build FAILED"
          cat "logs/build.log"
          echo "SUCCESS_COUNT=0" >> $GITHUB_ENV
          echo "FAILED_COUNT=1" >> $GITHUB_ENV
        fi

    - name: Upload logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: nightly-build-logs
        path: logs/
        retention-days: 7

    - name: Create summary
      run: |
        echo "# Nightly Build Report üåô" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Date:** $(date -u +"%Y-%m-%d %H:%M UTC")" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Results" >> $GITHUB_STEP_SUMMARY
        echo "- Build status: $([ "${{ env.SUCCESS_COUNT }}" -eq 1 ] && echo "‚úÖ Success" || echo "‚ùå Failed")" >> $GITHUB_STEP_SUMMARY
        echo "- Package: CPRTrainer.iq (universal for all manifest devices)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ "${{ env.FAILED_COUNT }}" -gt 0 ]; then
          echo "‚ö†Ô∏è Build failed. Check logs for details." >> $GITHUB_STEP_SUMMARY
        else
          echo "‚úÖ Build successful for all devices in manifest!" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Notify on failure
      if: env.FAILED_COUNT > 0
      run: |
        echo "‚ö†Ô∏è Nightly build has failures!"
        echo "Failed builds: ${{ env.FAILED_COUNT }}"
        # Here you could add Slack/Discord notification
        # or create an issue automatically
