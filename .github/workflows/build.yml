name: Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build:
    name: Build Connect IQ App
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up environment
      run: |
        echo "Setting up build environment..."
        sudo apt-get update
        sudo apt-get install -y wget unzip

    - name: Cache Connect IQ SDK
      id: cache-sdk
      uses: actions/cache@v4
      with:
        path: ~/connectiq-sdk
        key: ${{ runner.os }}-connectiq-sdk-8.4.1

    - name: Download and install Connect IQ SDK
      if: steps.cache-sdk.outputs.cache-hit != 'true'
      run: |
        echo "Downloading Connect IQ SDK..."
        mkdir -p ~/connectiq-sdk
        cd ~/connectiq-sdk
        # Download SDK (update URL to latest version)
        wget -q https://developer.garmin.com/downloads/connect-iq/sdks/connectiq-sdk-lin-8.4.1-2026-02-03-e9f77eeaa.zip -O sdk.zip
        unzip -q sdk.zip
        rm sdk.zip
        chmod +x bin/monkeyc bin/monkeydo
        echo "SDK installed successfully"

    - name: Add SDK to PATH
      run: |
        echo "$HOME/connectiq-sdk/bin" >> $GITHUB_PATH
        export PATH="$HOME/connectiq-sdk/bin:$PATH"

    - name: Decode developer key
      run: |
        echo "Decoding developer key from secrets..."
        echo "${{ secrets.DEVELOPER_KEY_DER }}" | base64 -d > developer_key.der
        echo "Developer key ready"

    - name: Verify project structure
      run: |
        echo "Verifying project structure..."
        ls -la
        test -f manifest.xml || (echo "manifest.xml not found!" && exit 1)
        test -f monkey.jungle || (echo "monkey.jungle not found!" && exit 1)
        test -d source || (echo "source directory not found!" && exit 1)
        test -f resources/drawables/launcher_icon.png || (echo "launcher_icon.png not found!" && exit 1)
        echo "Project structure OK"

    - name: Build universal .iq package
      run: |
        echo "Building universal .iq package for all devices..."
        mkdir -p bin
        ~/connectiq-sdk/bin/monkeyc \
          -o bin/CPRTrainer.iq \
          -f monkey.jungle \
          -y developer_key.der \
          -r \
          -w
        echo "Build successful!"

    - name: List build artifacts
      run: |
        echo "Build artifacts:"
        ls -lh bin/

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: cpr-trainer-build
        path: bin/*.iq
        retention-days: 30

    - name: Build summary
      run: |
        echo "### Build Summary :rocket:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "✅ **Build successful!**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Package:** CPRTrainer.iq (universal package for all devices)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Supported devices:** See manifest.xml for complete list" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Artifact available for download in the Actions tab." >> $GITHUB_STEP_SUMMARY

  lint:
    name: Code Quality Checks
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check for TODO comments
      run: |
        echo "Checking for TODO comments..."
        if grep -r "TODO\|FIXME\|XXX\|HACK" source/ --color=always; then
          echo "⚠️ Found TODO/FIXME comments - consider addressing them"
        else
          echo "✅ No TODO/FIXME comments found"
        fi

    - name: Check file permissions
      run: |
        echo "Checking file permissions..."
        find source/ -type f -name "*.mc" -executable && \
          echo "⚠️ Found executable source files - they should not be executable" || \
          echo "✅ File permissions OK"

    - name: Validate manifest.xml
      run: |
        echo "Validating manifest.xml..."
        if command -v xmllint &> /dev/null; then
          xmllint --noout manifest.xml && echo "✅ manifest.xml is valid" || exit 1
        else
          echo "⚠️ xmllint not available, skipping validation"
        fi

    - name: Check for sensitive data
      run: |
        echo "Checking for sensitive data..."
        if grep -r -i "password\|secret\|apikey\|api_key" source/ resources/ --exclude-dir=.git; then
          echo "⚠️ Potential sensitive data found!"
          exit 1
        else
          echo "✅ No sensitive data found"
        fi

  documentation:
    name: Documentation Checks
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check README exists
      run: |
        test -f README.md || (echo "❌ README.md not found!" && exit 1)
        echo "✅ README.md exists"

    - name: Check DISCLAIMER exists
      run: |
        test -f DISCLAIMER.md || (echo "❌ DISCLAIMER.md not found!" && exit 1)
        echo "✅ DISCLAIMER.md exists"

    - name: Check LICENSE exists
      run: |
        test -f LICENSE || (echo "❌ LICENSE not found!" && exit 1)
        echo "✅ LICENSE exists"

    - name: Check for broken links in README
      run: |
        echo "Checking for broken internal links..."
        # Check if linked files exist
        for file in INSTALLATION.md PUBLISHING.md DISCLAIMER.md DEPTH_SENSOR.md ICON_SPECS.md REFERENCES.bib CI_CD_GUIDE.md DEPENDENCIES.md; do
          if grep -q "$file" README.md; then
            test -f "$file" && echo "✅ $file exists" || (echo "❌ $file referenced but not found!" && exit 1)
          fi
        done

    - name: Check documentation size
      run: |
        echo "Documentation statistics:"
        wc -l *.md | sort -n
        echo ""
        echo "Total documentation lines: $(cat *.md | wc -l)"
